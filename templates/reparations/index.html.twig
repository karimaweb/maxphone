{% extends 'base.html.twig' %}

{% block title %}Suivi des R√©parations{% endblock %}

{% block body %}
    <div class="container mt-4">
        {# <h1> Suivi de vos R√©parations</h1> #}

        {% if app.user %}
            <div class="alert alert-info">
                Bonjour <strong>{{ app.user.getNomUtilisateur() }} {{ app.user.getPrenomUtilisateur() }}</strong> , voici le suivi de vos r√©parations.
            </div>
        {# {% else %}
            <p class="alert alert-warning"> Vous n'√™tes pas connect√©.</p>
        {% endif %} #}

        <table class="table table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Produit</th>
                    <th>Date D√©p√¥t</th>
                    <th>Dernier Statut</th>
                </tr>
            </thead>
            <tbody id="reparations-container">
                <tr>
                    <td colspan="4" class="text-center">Chargement des r√©parations...</td>
                </tr>
            </tbody>
        </table>

        {# <div class="text-center mt-3">
            <button id="showHistoryBtn" class="btn btn-primary">üîç Voir l‚Äôhistorique complet</button>
        </div> #}
    </div>
    {% else %}
            <div class="alert alert-warning">
                 Vous n'√™tes pas connect√©. Veuillez <a href="{{ path('app_login') }}">vous connecter</a> pour voir vos r√©parations.
            </div>
        {% endif %}
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            fetch("/api/mes-reparations")
                .then(response => response.json())
                .then(data => {
                    let container = document.getElementById("reparations-container");
                    container.innerHTML = "";

                    if (data.error) {
                        container.innerHTML = `<tr><td colspan="4" class="text-danger">${data.error}</td></tr>`;
                        return;
                    }

                    if (data.length === 0) {
                        container.innerHTML = "<tr><td colspan='4' class='text-center'>Aucune r√©paration en cours.</td></tr>";
                        return;
                    }

                    data.forEach(reparation => {
                        let row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${reparation.produit}</td>
                            <td>${reparation.dateDepot}</td>
                            <td>
                                <span class="badge ${getStatusClass(reparation.statut)}">${reparation.statut}</span>
                            </td>
                            
                        `;
                        container.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error("Erreur API:", error);
                    document.getElementById("reparations-container").innerHTML = "<tr><td colspan='4' class='text-danger'>Erreur lors du chargement.</td></tr>";
                });
        });

        function getStatusClass(statut) {
            const statusMapping = {
                "En attente": "bg-secondary",
                "Pi√®ce command√©e": "bg-primary",
                "Pi√®ce re√ßue": "bg-info",
                "D√©but de r√©paration": "bg-warning text-dark",
                "Test final en cours": "bg-warning",
                "Termin√©": "bg-success",
                "Annul√©": "bg-danger"
            };
            return statusMapping[statut] || "bg-light text-dark";
        }

        function showDetails(id) {
            alert(" Affichage des d√©tails de la r√©paration ID: " + id);
            // Ici, tu peux rediriger vers une page de d√©tails
        }

        document.getElementById("showHistoryBtn").addEventListener("click", function () {
            alert("Chargement de l'historique complet...");
            // Ici, tu peux ajouter une requ√™te AJAX pour r√©cup√©rer l'historique complet
        });
    </script>

   

{% endblock %}
